---
path: "jquery-google-maps-tutorial-ajax-php-mysql"
title: "jQuery and Google Maps #2: AJAX Storing and Retrieving Points"
description: "Storing and retrieving points with the Google Maps API using PHP."
tags: 
  - "Google Maps"
  - "JavaScript & jQuery"
  - "jQuery"
date: "2009-04-28T11:51:21.000Z"
draft: false
category: "test"
layout: "post"
---

Continuing the "series on jQuery and Google Maps":http://marcgrabanski.com/article/jquery-google-maps-tutorial-basics, I will teach you how to store and retrieve points with using AJAX and a server-side language. This tutorial will use PHP/MySQL on the server, but it is basic enough that re-writing in another language should not be difficult. "View Final Demo":http://marcgrabanski.com/resources/jquery-google-maps/tutorial-part2.html !http://marcgrabanski.com/img/google-maps-form-jquery.jpg!:http://marcgrabanski.com/resources/jquery-google-maps/tutorial-part2.html First, let me share with you the design-pattern behind the tutorial. My design pattern has two steps. The first is to use a simple HTML form to create new locations by posting the data to the server via AJAX. The second step is to fetch those locations from the server also via AJAX. Sound simple? Well, then lets get started... bq. Note: This tutorial builds on the first tutorial's code, so all code I am showing you here will be added onto it. h2. Step #1: Create the, "Add Location" Form To allow users to add locations to the map, let's create a basic form. This will include the parts of an address, as well as the name of the location. \[code lang="html"\]

Add a Point to the Map

Location Name 

Address 

Add Point

\[/code\] A couple things to note about the form: * The form's action is pointed to map-service.php, which is where we will process the form data. * A hidden input @@ will be used on the server to flag that we want to save a point to the database. This is just a personal preference on how to do things, there are many other ways to flag the intended action. * An empty div with class error @

@ is placed in the form to be used in a later step to display errors. h2. Step #2: Add Styles to the Form By adding a few CSS rules to our page, we will set our form next to the map and spruce up the form a bit. \[code lang="css"\] #add-point { float:left; } div.input { padding:3px 0; } label { display:block; font-size:80%; } input, select { width:150px; } button { float:right; } div.error { color:red; font-weight:bold; } \[/code\] h2. Step #3: Geoencode Address Before Submiting Data h3. 3a) Override default form submit At this point we'll override the form's default submit action by selecting the form @$("#add-point")@ , then using jQuery's "submit event method":http://docs.jquery.com/Events/submit . This method accepts a function that will run on submit of the form. \[code lang="js"\] $("#add-point").submit(function(){ geoEncode(); return false; }); \[/code\] h3. 3b) Add GeoCoder Then, inside the submit we will post the form data with AJAX using jQuery's "ajax post method":http://docs.jquery.com/Ajax/jQuery.post . \[code lang="js"\] var geo = new GClientGeocoder(); var reasons=\[\]; reasons\[G\_GEO\_SUCCESS\] = "Success"; reasons\[G\_GEO\_MISSING\_ADDRESS\] = "Missing Address"; reasons\[G\_GEO\_UNKNOWN\_ADDRESS\] = "Unknown Address."; reasons\[G\_GEO\_UNAVAILABLE\_ADDRESS\] = "Unavailable Address"; reasons\[G\_GEO\_BAD\_KEY\] = "Bad API Key"; reasons\[G\_GEO\_TOO\_MANY\_QUERIES\] = "Too Many Queries"; reasons\[G\_GEO\_SERVER\_ERROR\] ="Server error"; \[/code\] h3. 3c) Get geocode from address \[code lang="js"\] function geoEncode() { var address = $("#add-point input\[name=address\]").val(); geo.getLocations(address, function (result){ if (result.Status.code == G\_GEO_SUCCESS) { geocode = result.Placemark\[0\].Point.coordinates; savePoint(geocode); } else { var reason="Code"+result.Status.code; if (reasons\[result.Status.code\]) { reason = reasons\[result.Status.code\] } $("#add-point .error").html(reason).fadeIn(); geocode = false; } }); } \[/code\] h2. Step #4: Submit Data to Server \[code lang="js"\] function savePoint(geocode) { var data = $("#add-point :input").serializeArray(); data\[data.length\] = { name:"lng", value: geocode\[0\] }; data\[data.length\] = { name:"lat", value: geocode\[1\] }; $.post($("#add-point").attr('action'), data, function(json){ $("#add-point .error").fadeOut(); if (json.status =="fail") { $("#add-point .error").html(json.message).fadeIn(); } if (json.status =="success") { $("#add-point :input\[name!=action\]").val(""); var location = json.data; addLocation(location); zoomToBounds(); } }, "json"); } \[/code\] The @$.post@ method accepts parameters. # \*URL\* to post data to: @$(this).attr('action')@ will get the action attribute from the form that was submitted in the previous step. # \*Data\* in name, value pairs i.e. @{ name:"inputname", value:"inputvalue"}@ we will get all the inputs using the :input selector in jQuery, then use the "serialize array":http://docs.jquery.com/Ajax/serializeArray function to turn those inputs into name, value pairs. Then add the two geocode name/value pairs to the data object. # \*Function\* to run after AJAX response is received. This function has one parameter which contains the response of the AJAX request. # \*Type of data\* to be returned (optional). In this case we will use JSON. h2. Step #5: Use PHP on the Server to Process the Form Once the data is posted with jQuery, we can handle it on the server with PHP. h3. 5a) Check the action and validate the name Let's simply check if the action variable is posted as,"savepoint". Then validate that the name has the proper characters with a regular expression and also that it is not empty. If any data is invalid, let's call a fail method (defined in next sub-step) with the message we want to show to the user. \[code lang="php"\] \[/code\] Save the file as map-service.php or whatever you named your form's action attribute. h3. 5b) Output the error message as a JSON object Our fail function will use PHP's "die method":http://us.php.net/manual/en/function.die.php to stop the script from executing and output an error message to the client. Since the front-end (jQuery) is expecting a JSON object, we want to make sure to always send back a JSON response. To output JSON with PHP, you simply pass an array into the "json encode method":http://us.php.net/manual/en/function.json-encode.php (json\_encode is PHP 5.2+ only, if you are using less than 5.2 then use the "JSON PHP library":http://mike.teczno.com/JSON/JSON.phps ). \[code lang="js"\] function fail($message) { die(json\_encode(array('status' => 'fail', 'message' => $message))); } \[/code\] For the JSON array we want to use the "JSEND specification":http://labs.omniti.com/trac/jsend for sending back a response. Basically, you have a key/value pair of status equals success or fail. That way the response can easily be checked on the front-end. I'm deviating from the JSEND spec a little bit by only sending a string back instead of a key/value pair of messages. Using "Firebug":http://getfirebug.com/ and "Firefox":http://www.mozilla.com/en-US/firefox/personal.html , we can inspect the Ajax requests easily within the browser. !http://marcgrabanski.com/img/google-maps-firebug-json-error.jpg! You can see here I submitted the form without entering a name and it sent me back an error message in the form of JSON. h2. Step #6: Display the Error Messages with jQuery Hopping back to the jQuery code, we will write the error handling. Inside the post code, we will first use the "hide method":http://docs.jquery.com/Effects/hide to hide the error div in case it is already displaying. Then check if @json.status@ is showing,"fail". If it is, we'll place the @json.message@ inside the error div with jQuery's "html attribute method":http://docs.jquery.com/Attributes/html and then fade it in with the "fade in method":http://docs.jquery.com/Effects/fadeIn . \[code lang="js"\] $("#add-point .error").hide(); if (json.status =="fail") { $("#add-point .error").html(json.message).fadeIn(); } \[/code\] h2. Step #7: Create a Database and Store the Locations Using SQL, create a database table named locations which has a"name","latitude","longitude"and an"id"in it. If you need help with this, you will have to consult "w3schools php and mysql":http://www.w3schools.com/PHP/php\_mysql\_intro.asp for more help. h3. 7a) Create the table with SQL \[code lang='sql'\] CREATE TABLE \`locations\` ( \`id\` int(11) unsigned NOT NULL auto\_increment, \`name\` varchar(100) default NULL, \`lat\` float(15,11) default NULL, \`lng\` float(15,11) default NULL, PRIMARY KEY (\`id\`) ) \[/code\] h3. 7b) Insert name and location into the database with PHP and MySQL We will use PHP and MySQL to insert the new location into the database. Directly after, we will either flag a success or fail message to the user. \[code lang="php"\] $query ="INSERT INTO locations SET name='$\_POST\[name\]', lat='$lat', lng='$lng'"; $result = map\_query($query); if ($result) { success(array('lat' =>$\_POST\['lat'\], 'lng' =>$\_POST\['lng'\], 'name' =>$name)); } else { fail('Failed to add point.'); } \[/code\] If you noticed, I created a custom function called @map\_query@ to abstract out the database stuff. Here is the function definition. Make sure to update the,"MYSQL"stuff with your credentials. \[code lang="php"\] function map\_query($query) { mysql\_connect('MYSQL\_HOST', 'MYSQL\_USER', 'MYSQL\_PASSWORD') OR die(fail('Could not connect to database.')); mysql\_select\_db ('MYSQL\_DATABASE'); return mysql\_query($query); } \[/code\] I also created a similar method to"fail"called"success"which looks like: \[code lang="js"\] function success($data) { die(json\_encode(array('status' =>'success', 'data' =>$data))); } \[/code\] An example of a succesful response in firebug: !http://marcgrabanski.com/img/google-maps-firebug-json-success.jpg! h2. Step #8: Map the New Point Going back to the jQuery code, we can now add the success response handling. The response is a JSON object with"lat","lng"and"name"properties. I'll give you the code inside the success handling, then later show you what each custom function is doing. \[code lang="js"\] if (json.status =="success") { $("#add-point :input\[name!=action\]").val(""); var location = json.data; addLocation(location); zoomToBounds(); } \[/code\] After a location is successfully added to the database, we want to clear the form to prevent duplicate entry. Do this by selecting the inputs with the @:input@ selector. Then we need to filter out theaction input, do this by using the "attribute not equal selector":http://docs.jquery.com/Selectors/attributeNotEqual#attributevalue @\[name!=action\]@ . My @addLocation(location)@ function is simply our code from the "last tutorial":http://marcgrabanski.com/article/jquery-google-maps-tutorial-basics placed into a function to be reusable later. \[code lang="js"\] function addLocation(location) { var point = new GLatLng(location.lat, location.lng); var marker = new GMarker(point); map.addOverlay(marker); bounds.extend(marker.getPoint()); $("*   ") .html(location.name) .click(function(){ showMessage(marker, location.name); }) .appendTo("#list"); GEvent.addListener(marker,"click", function(){ showMessage(this); }); } \[/code\] It has a few things you might want to note: * using location.name, location.lat and location.lng means that we will be passing in a location object with those properties to the function. * Ignore @bounds.extend(marker.getPoint());@ and @zoomToBounds@ for now or skip to #13 quickly to find out what they do. h2. Step #9: Load and Display the Locations from in the Database When the page initially loads, we want to load all of our stored points. The simplest way to do this (in my opinion) is to do a GET request to fetch a JSON object from the server after the page loads. To make a,"GET"request to the server, we can use jQuery's "getJson method":http://docs.jquery.com/Ajax/jQuery.getJSON . We will send the server a,"get"variable called action with value,"listpoints". \[code lang="js"\] $.getJSON("php/map-service.php?action=listpoints", function(json) { // do stuff in step #11 }); \[/code\] h2. Step #10: Get the Locations from the Database Simply check the,"GET"action in the PHP and run this code to fetch the locations records. Pretty straight-forward code here. We are creating an array of points and then sending them back to the client as JSON. \[code lang="php"\] if ($\_GET\['action'\] == 'listpoints') { $query ="SELECT * FROM locations"; $result = map\_query($query); $points = array(); while ($row = mysql\_fetch\_array($result, MYSQL\_ASSOC)) { array\_push($points, array('name' =>$row\['name'\], 'lat' =>$row\['lat'\], 'lng' =>$row\['lng'\])); } echo json_encode(array("Locations"=>$points)); exit; } \[/code\] h2. Step #11: Display the Locations Iterate through the JSON object that contains the locations inside the getJson response function. \[code lang="js"\] if (json.Locations.length>0) { for (i=0; i